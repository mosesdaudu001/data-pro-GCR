{% extends "base.html" %}

{% block title %}Audit Trail - CBL GRC Platform{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-history"></i> Comprehensive Audit Trail</h2>
                <p class="text-muted">Complete activity logging and forensic audit capabilities for compliance and security</p>
            </div>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
                    <i class="fas fa-filter"></i> Advanced Filter
                </button>
                <button class="btn btn-outline-secondary" onclick="exportAuditLog()">
                    <i class="fas fa-download"></i> Export Log
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Audit Summary Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ audit_logs|length }}</h4>
                        <p class="card-text">Total Activities</p>
                        <small>Last 24 hours</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-list fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{% set login_count = audit_logs|selectattr('2', 'equalto', 'Login')|list|length %}{{ login_count }}</h4>
                        <p class="card-text">Login Activities</p>
                        <small>User sessions</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-sign-in-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{% set view_count = audit_logs|selectattr('2', 'equalto', 'View')|list|length %}{{ view_count }}</h4>
                        <p class="card-text">Data Access</p>
                        <small>View operations</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-eye fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">0</h4>
                        <p class="card-text">Security Alerts</p>
                        <small>Suspicious activities</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-shield-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Bar -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">Date From</label>
                        <input type="date" class="form-control" value="2024-10-01">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Date To</label>
                        <input type="date" class="form-control" value="2024-10-15">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">User</label>
                        <select class="form-select">
                            <option value="">All Users</option>
                            <option>admin</option>
                            <option>risk_manager</option>
                            <option>compliance</option>
                            <option>auditor</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Action</label>
                        <select class="form-select">
                            <option value="">All Actions</option>
                            <option>Login</option>
                            <option>Logout</option>
                            <option>View</option>
                            <option>Edit</option>
                            <option>Delete</option>
                            <option>Export</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Module</label>
                        <select class="form-select">
                            <option value="">All Modules</option>
                            <option>Dashboard</option>
                            <option>Risk Management</option>
                            <option>Compliance</option>
                            <option>Reporting</option>
                            <option>Analytics</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary d-block">
                            <i class="fas fa-search"></i> Filter
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Audit Log Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-list"></i> Audit Log Entries</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-secondary active">Real-time</button>
                        <button class="btn btn-outline-secondary">Batch</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Module</th>
                                <th>Details</th>
                                <th>IP Address</th>
                                <th>Session ID</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogTable">
                            {% for log in audit_logs %}
                            <tr>
                                <td>
                                    <span class="text-nowrap">{{ log[5][:16] }}</span>
                                    <br>
                                    <small class="text-muted">{{ log[5][11:19] }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-{% if log[1] == 'admin' %}danger{% elif log[1] == 'risk_manager' %}warning{% elif log[1] == 'compliance' %}success{% else %}info{% endif %}">
                                        {{ log[1] }}
                                    </span>
                                </td>
                                <td>
                                    <i class="fas fa-{% if log[2] == 'Login' %}sign-in-alt text-success{% elif log[2] == 'Logout' %}sign-out-alt text-secondary{% elif log[2] == 'View' %}eye text-info{% elif log[2] == 'Edit' %}edit text-warning{% elif log[2] == 'Delete' %}trash text-danger{% else %}cog{% endif %} me-1"></i>
                                    {{ log[2] }}
                                </td>
                                <td>{{ log[3] }}</td>
                                <td>
                                    <span class="text-truncate d-inline-block" style="max-width: 200px;" title="{{ log[4] }}">
                                        {{ log[4] }}
                                    </span>
                                </td>
                                <td>
                                    <code class="text-muted">192.168.1.{{ range(10, 255) | random }}</code>
                                </td>
                                <td>
                                    <code class="text-muted">{{ log[0] }}{{ range(1000, 9999) | random }}</code>
                                </td>
                                <td>
                                    <span class="badge bg-success">Success</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Audit log pagination">
                    <ul class="pagination pagination-sm justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Previous</a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Security Analytics -->
<div class="row mt-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-shield-alt"></i> Security Analytics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Failed Login Attempts</h6>
                                <h4 class="text-success">0</h4>
                                <small class="text-muted">Last 24 hours</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Unusual Activity</h6>
                                <h4 class="text-success">0</h4>
                                <small class="text-muted">No anomalies detected</small>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <h6>Recent Security Events</h6>
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold text-success">System Security Check</div>
                            All security protocols validated
                        </div>
                        <small class="text-muted">1 hour ago</small>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold text-info">Password Policy Update</div>
                            Enhanced password requirements applied
                        </div>
                        <small class="text-muted">6 hours ago</small>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold text-success">Backup Completed</div>
                            Audit logs backed up successfully
                        </div>
                        <small class="text-muted">12 hours ago</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-chart-line"></i> Activity Patterns</h5>
            </div>
            <div class="card-body">
                <h6>Peak Activity Hours</h6>
                <div class="progress mb-2">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 85%">
                        9:00 AM - 11:00 AM (85%)
                    </div>
                </div>
                <div class="progress mb-2">
                    <div class="progress-bar bg-info" role="progressbar" style="width: 70%">
                        2:00 PM - 4:00 PM (70%)
                    </div>
                </div>
                <div class="progress mb-3">
                    <div class="progress-bar bg-warning" role="progressbar" style="width: 45%">
                        7:00 PM - 9:00 PM (45%)
                    </div>
                </div>
                
                <h6>Most Active Users</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Actions</th>
                                <th>Last Active</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="badge bg-warning">risk_manager</span></td>
                                <td>42</td>
                                <td>2 mins ago</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-success">compliance</span></td>
                                <td>31</td>
                                <td>15 mins ago</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-danger">admin</span></td>
                                <td>28</td>
                                <td>1 hour ago</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-filter"></i> Advanced Audit Log Filter</h5>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Apply Filters</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function exportAuditLog() {
    alert('Export audit log functionality would be implemented here');
}

// Real-time log updates simulation
function updateAuditLog() {
    // In production, this would fetch new log entries via WebSocket or polling
    console.log('Checking for new audit log entries...');
}

// Auto-refresh every 30 seconds
setInterval(updateAuditLog, 30000);

// Log entry detail modal
function showLogDetail(logId) {
    alert('Show detailed log entry for ID: ' + logId);
}

// Search functionality
document.addEventListener('DOMContentLoaded', function() {
    // Real-time search in audit logs
    const searchInput = document.querySelector('input[placeholder="Search for specific actions or events"]');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            // Implement search functionality
            console.log('Searching for: ' + this.value);
        });
    }
});
</script>
{% endblock %}" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date Range</label>
                            <div class="input-group">
                                <input type="datetime-local" class="form-control">
                                <span class="input-group-text">to</span>
                                <input type="datetime-local" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Severity Level</label>
                            <select class="form-select">
                                <option>All Levels</option>
                                <option>Critical</option>
                                <option>High</option>
                                <option>Medium</option>
                                <option>Low</option>
                                <option>Info</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">IP Address Range</label>
                            <input type="text" class="form-control" placeholder="192.168.1.0/24">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Session ID</label>
                            <input type="text" class="form-control" placeholder="Enter session ID">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Search in Details</label>
                        <input type="text" class="form-control" placeholder="Search for specific actions or events">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeSystem">
                                <label class="form-check-label" for="includeSystem">
                                    Include System Events
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeFailures">
                                <label class="form-check-label" for="includeFailures">
                                    Include Failed Actions
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Clear Filters</button>
                <button type="button